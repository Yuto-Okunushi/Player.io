<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>動物ボタン</title>
</head>
<body>
  <h1>動物ボタンでAWS WebSocket通信</h1>
  <button onclick="send(1)">カバ</button>
  <button onclick="send(2)">ウサギ</button>
  <button onclick="send(3)">モモンガ</button>
  <button onclick="send(4)">ニホンザル</button>

  <script>
    // ✅ WebSocketサーバーのURL（SSL対応済なら "wss://" を使う）
    const WS_URL = "wss://ec2-3-27-119-133.ap-northeast-1.compute.amazonaws.com:8080";

    // ✅ グローバルな WebSocket 変数（1回だけ定義）
    let socket;

    function connectWebSocket() {
      socket = new WebSocket(WS_URL);

      socket.onopen = () => {
        console.log("✅ WebSocket接続完了");
      };

      socket.onerror = (error) => {
        console.error("❌ WebSocketエラー:", error);
      };

      socket.onmessage = (event) => {
        console.log("📩 サーバーから受信:", event.data);
      };

      socket.onclose = (event) => {
        console.warn("⚠️ WebSocket接続が閉じられました。コード:", event.code, "理由:", event.reason);
      };
    }

    function send(value) {
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(value.toString());
        console.log("📤 送信:", value);
      } else {
        console.warn("⛔ WebSocketが未接続。再接続を試みます...");
        connectWebSocket();
        // ※再接続後すぐには送れないので、遅延送信などが必要になる
      }
    }

    // ページ読み込み時に接続
    window.onload = () => {
      connectWebSocket();
    };

    // ページ離脱時に切断
    window.onbeforeunload = () => {
      if (socket) {
        socket.close();
      }
    };
  </script>
</body>
</html>
