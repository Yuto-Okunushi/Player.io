<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動物議論ゲーム</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-image: url('18.png');
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        .overlay {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: url('17.png');
            background-repeat: repeat;
            background-size: 1500px auto;
            transform: rotate(45deg);
            opacity: 0.2;
            animation: diagonalScroll 40s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes diagonalScroll {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 100% 200%;
            }
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 100;
        }

        .status-connected {
            background: rgba(40, 167, 69, 0.8);
        }

        .status-waiting {
            background: rgba(255, 193, 7, 0.8);
        }

        .status-disconnected {
            background: rgba(220, 53, 69, 0.8);
        }

        /* 動物決定画面のスタイル（参考デザインに基づく） */
        .animal-reveal {
            text-align: center;
            color: white;
            text-shadow: 0 0 5px #4b463e;
            position: absolute;
            top: 20vh;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: rgba(0, 0, 0, 0.1);
            padding: 1rem 2rem;
            border-radius: 12px;
            max-width: 90vw;
            user-select: none;
            display: none;
        }

        .animal-reveal .top-text {
            font-size: 2rem;
            margin-bottom: 1vh;
        }

        .animal-reveal .animal-name {
            font-size: 2.5rem;
            font-weight: bold;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 1s ease, transform 1s ease;
        }

        .animal-reveal.show .animal-name,
        .animal-reveal.show .animal-image,
        .animal-reveal.show .animal-desc,
        .animal-reveal.show .ok-button {
            opacity: 1;
            transform: translateY(0);
        }

        .animal-reveal .animal-desc {
            font-size: 2rem;
            margin-top: 1vh;
            opacity: 0;
            transition: opacity 1s ease 0.5s, transform 1s ease 0.5s;
        }

        .animal-reveal .animal-image {
            width: 50vw;
            max-width: 220px;
            margin-top: 2vh;
            opacity: 0;
            animation: rotateIn 2s forwards 1s;
        }

        @keyframes rotateIn {
            0% {
                transform: rotateY(0deg) scale(0.2);
                opacity: 0;
            }
            100% {
                transform: rotateY(360deg) scale(1);
                opacity: 1;
            }
        }

        .ok-button {
            margin-top: 3vh;
            font-size: 1.5rem;
            padding: 0.7rem 2rem;
            background: #88b04b;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 1s ease 1.5s, background-color 0.3s ease;
        }

        .ok-button:hover {
            background: #6b8f39;
        }

        /* メイン画面のスタイル */
        .main-content {
            display: none;
            width: 100%;
            height: 100%;
            position: relative;
        }

        .headline {
            position: absolute;
            top: 40%;
            left: 50%;
            display: none;
            transform: translateX(-50%);
            color: #fff;
            font-size: 1.4rem;
            text-align: center;
            text-shadow: 0 0 5px #5c5045;
            font-weight: bold;
            white-space: nowrap;
            max-width: 100vw;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .animal-info {
            position: absolute;
            top: 5vh;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: white;
            text-shadow: 0 0 5px #4b463e;
            max-width: 90vw;
            font-size: 4.5vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .animal-info.visible {
            opacity: 1;
        }

        .animal-info .title {
            font-size: 5.5vw;
            font-weight: bold;
        }

        .animal-info .description {
            font-size: 3.5vw;
            margin-top: 0.5vh;
        }

        .animal-image {
            width: 40vw;
            max-width: 200px;
            height: auto;
            margin-top: 1vh;
        }

        @media (min-width: 768px) {
            .animal-info .title {
                font-size: 2rem;
            }

            .animal-info .description {
                font-size: 1.2rem;
            }

            .animal-image {
                width: 150px;
            }
        }

        .card-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: flex-end;
            position: absolute;
            bottom: 0;
            right: 0;
            padding: 2rem;
        }

        .card-button {
            width: 90vw;
            max-width: 400px;
            height: auto;
            position: relative;
            padding: 0;
            margin: 0;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.0rem;
        }

        .card-button img {
            display: block;
            width: 50%;
            height: 50%;
            transition: transform 0.3s ease, filter 0.3s ease;
        }

        .card-button:hover img {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        .card-label {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #280508;
            font-weight: bold;
            pointer-events: none;
            user-select: none;
            font-size: 50%;
            transition: transform 0.3s ease, filter 0.3s ease;
        }

        .card-button:hover .card-label {
            transform: translate(-50%, -50%) scale(1.05);
            filter: brightness(1.1);
        }

        .card-button.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .confirmation-content {
            background: #ede6d0;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 90vw;
        }

        .confirmation-text {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .confirmation-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .confirm-btn, .cancel-btn {
            padding: 0.8rem 2rem;
            font-size: 1.2rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .confirm-btn {
            background: #88b04b;
            color: white;
        }

        .confirm-btn:hover {
            background: #6b8f39;
        }

        .cancel-btn {
            background: #a93f2c;
            color: white;
        }

        .cancel-btn:hover {
            background: #8b2e1f;
        }

        .status-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.8rem;
            text-shadow: 0 0 5px #4b463e;
            white-space: nowrap;
        }

        .players-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            z-index: 100;
            max-width: 300px;
        }

        .players-info h3 {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }

        .player-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            gap: 10px;
        }

        .player-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
        }

        .player-status.waiting {
            background: #ffc107;
        }

        .player-status.disconnected {
            background: #dc3545;
        }

        .loading-dots {
            display: inline-block;
            width: 20px;
        }

        /* 接続待機画面 */
        .waiting-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.8rem;
            text-shadow: 0 0 5px #4b463e;
            text-align: center;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="overlay"></div>
    
    <!-- 接続状態表示 -->
    <div id="connection-status" class="connection-status status-waiting">
        接続中<span class="loading-dots">...</span>
    </div>

    <!-- 接続待機画面 -->
    <div id="waiting-screen" class="waiting-screen">
        サーバーに接続中<span class="loading-dots">...</span>
    </div>

    <!-- 動物決定画面 -->
    <div class="animal-reveal" id="animalReveal">
        <div class="top-text">あなたは</div>
        <div class="animal-name" id="animalName"></div>
        <div class="top-text">です</div>
        <img id="animalImage" class="animal-image" src="" alt="動物画像">
        <div class="animal-desc" id="animalDescription"></div>
        <button class="ok-button" id="okButton" onclick="startMainGame()">OK</button>
    </div>
    
    <!-- メインゲーム画面 -->
    <div id="mainContent" class="main-content">
        <!-- プレイヤー情報 -->
        <div id="players-info" class="players-info">
            <h3>プレイヤー (<span id="player-count">0</span>/4)</h3>
            <div id="players-list"></div>
        </div>

        <div id="animal-info" class="animal-info">
            <div class="title">あなたは</div>
            <div id="mainAnimalName" class="title"></div>
            <div id="mainAnimalDescription" class="description"></div>
            <img id="mainAnimalImage" src="" alt="動物画像" class="animal-image" />
        </div>

        <div id="headline" class="headline">議論で何をする？</div>

        <div id="status-message" class="status-message">プレイヤーを待機中</div>

        <div id="card-container" class="card-container" style="display: none;">
            <button class="card-button" onclick="showConfirmation(1, '話をまとめる')">
                <img src="UI_BG_useroptionday_ver001.png" />
                <span class="card-label">話をまとめる</span>
            </button>
            <button class="card-button" onclick="showConfirmation(2, '意見を言う')">
                <img src="UI_BG_useroptionday_ver001.png" />
                <span class="card-label">意見を言う</span>
            </button>
            <button class="card-button" onclick="showConfirmation(3, 'やるべきことを主張する')">
                <img src="UI_BG_useroptionday_ver001.png" />
                <span class="card-label">やるべきことを主張する</span>
            </button>
            <button class="card-button" onclick="showConfirmation(4, 'ご飯を食べる')">
                <img src="UI_BG_useroptionday_ver001.png" />
                <span class="card-label">ご飯を食べる</span>
            </button>
        </div>
    </div>

    <!-- 確認モーダル -->
    <div id="confirmation-modal" class="confirmation-modal">
        <div class="confirmation-content">
            <div class="confirmation-text">これで決定する？</div>
            <div class="confirmation-buttons">
                <button class="confirm-btn" onclick="confirmAction()">決定</button>
                <button class="cancel-btn" onclick="cancelAction()">キャンセル</button>
            </div>
        </div>
    </div>

    <script>
        // WebSocket接続設定（EC2のエンドポイントに変更してください）
        const WS_URL = "wss://ws.dcsaitolab.com";
        let socket;
        let userId = null;
        let currentAnimalId = null;
        let selectedActionId = null;
        let gameState = "waiting"; // waiting, reveal, main, discussion

        // 動物データ
        const animals = {
            1: { name: "カバ", description: "水辺に住む大きな動物です。", image: "CH_kaba_ver001.png" },
            2: { name: "ウサギ", description: "ぴょんぴょん跳ねる可愛い動物です。", image: "CH_usagi_ver001.png" },
            3: { name: "モモンガ", description: "滑空する夜行性の動物です。", image: "CH_momonga_ver001.png" },
            4: { name: "ニホンザル", description: "温泉に入ることで有名です。", image: "CH_saru_ver001.png" },
        };

        // プレイヤー管理
        let players = {};

        // DOM要素の取得
        const connectionStatus = document.getElementById("connection-status");
        const waitingScreen = document.getElementById("waiting-screen");
        const animalReveal = document.getElementById("animalReveal");
        const mainContent = document.getElementById("mainContent");
        const statusMessage = document.getElementById("status-message");
        const cardContainer = document.getElementById("card-container");
        const headline = document.getElementById("headline");
        const confirmationModal = document.getElementById("confirmation-modal");
        const playersInfo = document.getElementById("players-info");
        const playersList = document.getElementById("players-list");
        const playerCount = document.getElementById("player-count");
        const animalInfo = document.getElementById("animal-info");

        // ローディングアニメーション
        let dotState = 0;
        let loadingText = "接続中";
        const loadingInterval = setInterval(() => {
            dotState = (dotState + 1) % 4;
            const dots = ".".repeat(dotState);
            if (connectionStatus.textContent.includes("接続中")) {
                connectionStatus.innerHTML = `${loadingText}<span class="loading-dots">${dots}</span>`;
            }
            if (waitingScreen && waitingScreen.textContent.includes("接続中")) {
                waitingScreen.innerHTML = `サーバーに接続中<span class="loading-dots">${dots}</span>`;
            }
            if (statusMessage && statusMessage.textContent.includes("進行中") || statusMessage.textContent.includes("議論中") || statusMessage.textContent.includes("待機中")) {
                statusMessage.textContent = statusMessage.textContent.split('.')[0] + dots;
            }
        }, 500);

        // WebSocket接続
        function connectWebSocket() {
            try {
                socket = new WebSocket(WS_URL);

                socket.onopen = () => {
                    console.log("✅ WebSocket接続完了");
                    connectionStatus.textContent = "接続済み";
                    connectionStatus.className = "connection-status status-connected";
                    waitingScreen.textContent = "動物の割り当てを待機中...";
                    
                    // 参加リクエストを送信
                    socket.send(JSON.stringify({
                        type: "join",
                        timestamp: Date.now()
                    }));
                };

                socket.onerror = (error) => {
                    console.error("❌ WebSocketエラー:", error);
                    connectionStatus.textContent = "接続エラー";
                    connectionStatus.className = "connection-status status-disconnected";
                    waitingScreen.textContent = "接続エラーが発生しました";
                };

                socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleServerMessage(data);
                    } catch (e) {
                        console.log("📩 テキストメッセージ受信:", event.data);
                        handleLegacyMessage(event.data);
                    }
                };

                socket.onclose = (event) => {
                    console.warn("⚠️ WebSocket接続が閉じられました。コード:", event.code, "理由:", event.reason);
                    connectionStatus.textContent = "接続切断";
                    connectionStatus.className = "connection-status status-disconnected";
                    
                    // 再接続を試行
                    setTimeout(() => {
                        if (socket.readyState === WebSocket.CLOSED) {
                            connectWebSocket();
                        }
                    }, 3000);
                };

            } catch (error) {
                console.error("WebSocket接続失敗:", error);
                connectionStatus.textContent = "接続失敗";
                connectionStatus.className = "connection-status status-disconnected";
                waitingScreen.textContent = "接続に失敗しました";
            }
        }

        // サーバーメッセージハンドラー
        function handleServerMessage(data) {
            console.log("📩 サーバーメッセージ:", data);

            switch (data.type) {
                case "user_assigned":
                    userId = data.userId;
                    currentAnimalId = data.animalId;
                    updateAnimalDisplay(currentAnimalId);
                    showAnimalReveal();
                    break;

                case "players_update":
                    players = data.players;
                    updatePlayersDisplay();
                    break;

                case "game_start":
                    if (gameState === "main") {
                        startGameplay();
                    }
                    break;

                case "game_phase":
                    handleGamePhase(data.phase, data.data);
                    break;

                case "error":
                    console.error("サーバーエラー:", data.message);
                    break;
            }
        }

        // レガシーメッセージハンドラー（既存システムとの互換性）
        function handleLegacyMessage(message) {
            const value = message.trim();

            if (!isNaN(value) && animals[parseInt(value)]) {
                const id = parseInt(value);
                currentAnimalId = id;
                updateAnimalDisplay(id);
                showAnimalReveal();
            }

            if (value === "start") {
                if (gameState === "main") {
                    startGameplay();
                }
            } else if (value === "discuss") {
                loadingText = "議論中";
                cardContainer.style.display = "none";
                statusMessage.style.display = "block";
                headline.style.display = "none";
            } else if (value === "wait") {
                loadingText = "ストーリー進行中";
                cardContainer.style.display = "none";
                statusMessage.style.display = "block";
                headline.style.display = "none";
            }
        }

        // 動物表示更新
        function updateAnimalDisplay(animalId) {
            const animal = animals[animalId];
            if (!animal) return;

            // 動物決定画面の更新
            document.getElementById("animalName").textContent = animal.name;
            document.getElementById("animalDescription").textContent = animal.description;
            document.getElementById("animalImage").src = animal.image;

            // メイン画面の更新
            document.getElementById("mainAnimalName").textContent = animal.name;
            document.getElementById("mainAnimalDescription").textContent = animal.description;
            document.getElementById("mainAnimalImage").src = animal.image;

            // メイン画面で動物情報を表示可能にする
            animalInfo.classList.add("visible");
        }

        // 動物決定画面を表示し、アニメーションを開始
        function showAnimalReveal() {
            gameState = "reveal";
            waitingScreen.style.display = "none";
            animalReveal.style.display = "block";
            mainContent.style.display = "none";
            
            // アニメーション開始
            setTimeout(() => {
                animalReveal.classList.add("show");
            }, 500);
        }

        // メインゲーム画面に切り替え
        function startMainGame() {
            gameState = "main";
            animalReveal.style.display = "none";
            mainContent.style.display = "block";
            
            // サーバーに準備完了を通知
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: "ready",
                    userId: userId
                }));
            }
        }

        // プレイヤー表示更新
        function updatePlayersDisplay() {
            const count = Object.keys(players).length;
            playerCount.textContent = count;
            
            playersList.innerHTML = "";
            Object.values(players).forEach(player => {
                const playerDiv = document.createElement("div");
                playerDiv.className = "player-item";
                
                const statusDiv = document.createElement("div");
                statusDiv.className = `player-status ${player.status || "waiting"}`;
                
                const nameDiv = document.createElement("div");
                nameDiv.textContent = `${animals[player.animalId]?.name || "未定"} (プレイヤー${player.userId})`;
                
                playerDiv.appendChild(statusDiv);
                playerDiv.appendChild(nameDiv);
                playersList.appendChild(playerDiv);
            });
        }

        // ゲームプレイ開始
        function startGameplay() {
            cardContainer.style.display = "flex";
            statusMessage.style.display = "none";
            headline.style.display = "block";
            headline.textContent = "議論で何をする？";
            
            document.querySelectorAll('.card-button').forEach(btn => {
                btn.classList.remove('disabled');
            });
        }

        // ゲームフェーズ処理
        function handleGamePhase(phase, data) {
            switch (phase) {
                case "discussion":
                    loadingText = "議論中";
                    cardContainer.style.display = "none";
                    statusMessage.style.display = "block";
                    statusMessage.textContent = "議論中...";
                    headline.style.display = "none";
                    break;
                    
                case "waiting":
                    loadingText = "ストーリー進行中";
                    cardContainer.style.display = "none";
                    statusMessage.style.display = "block";
                    statusMessage.textContent = "ストーリー進行中...";
                    headline.style.display = "none";
                    break;
                    
                case "action_select":
                    startGameplay();
                    break;
            }
        }

        // アクション送信
        function send(actionId) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({ 
                    type: "action",
                    userId: userId,
                    senderId: currentAnimalId, 
                    actionId: actionId,
                    timestamp: Date.now()
                });
                socket.send(message);
                console.log("📤 送信:", message);
            } else {
                console.warn("⛔ WebSocketが未接続。再接続を試みます...");
                connectWebSocket();
            }
        }

        // 確認モーダル表示
        function showConfirmation(actionId, actionName) {
            selectedActionId = actionId;
            confirmationModal.style.display = "flex";
        }

        // アクション確定
        function confirmAction() {
            if (selectedActionId !== null) {
                document.querySelectorAll('.card-button').forEach(btn => {
                    btn.classList.add('disabled');
                });

                headline.textContent = "待機中...";
                headline.style.display = "block";

                send(selectedActionId);
                confirmationModal.style.display = "none";
                selectedActionId = null;
            }
        }

        // アクションキャンセル
        function cancelAction() {
            selectedActionId = null;
            confirmationModal.style.display = "none";
        }

        // 初期化
        window.onload = () => {
            connectWebSocket();
        };

        window.onbeforeunload = () => {
            if (socket) {
                socket.close();
            }
            clearInterval(loadingInterval);
        };
    </script>
</body>
</html>
