<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂãïÁâ©Ë≠∞Ë´ñ„Ç≤„Éº„É†</title>
    <style>
        /* Êó¢Â≠ò„ÅÆCSS„ÅØ„Åù„ÅÆ„Åæ„Åæ */
        body {
            margin: 0;
            padding: 0;
            background-image: url('18.png');
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        .overlay {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: url('17.png');
            background-repeat: repeat;
            background-size: 1500px auto;
            transform: rotate(45deg);
            opacity: 0.2;
            animation: diagonalScroll 40s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes diagonalScroll {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 100% 200%;
            }
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 100;
        }

        .status-connected {
            background: rgba(40, 167, 69, 0.8);
        }

        .status-waiting {
            background: rgba(255, 193, 7, 0.8);
        }

        .status-disconnected {
            background: rgba(220, 53, 69, 0.8);
        }

        /* ÂãïÁâ©Ê±∫ÂÆöÁîªÈù¢„ÅÆ„Çπ„Çø„Ç§„É´ÔºàÂèÇËÄÉ„Éá„Ç∂„Ç§„É≥„Å´Âü∫„Å•„ÅèÔºâ */
        .animal-reveal {
            text-align: center;
            color: white;
            text-shadow: 0 0 5px #4b463e;
            position: absolute;
            top: 20vh;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: rgba(0, 0, 0, 0.1);
            padding: 1rem 2rem;
            border-radius: 12px;
            max-width: 90vw;
            user-select: none;
            display: none; /* ÂàùÊúü„ÅØÈùûË°®Á§∫ */
        }

        .animal-reveal .top-text {
            font-size: 2rem;
            margin-bottom: 1vh;
        }

        .animal-reveal .animal-name {
            font-size: 2.5rem;
            font-weight: bold;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 1s ease, transform 1s ease;
        }

        .animal-reveal.show .animal-name,
        .animal-reveal.show .animal-image,
        .animal-reveal.show .animal-desc,
        .animal-reveal.show .ok-button {
            opacity: 1;
            transform: translateY(0);
        }

        .animal-reveal .animal-desc {
            font-size: 2rem;
            margin-top: 1vh;
            opacity: 0;
            transition: opacity 1s ease 0.5s, transform 1s ease 0.5s;
        }

        .animal-reveal .animal-image {
            width: 50vw;
            max-width: 220px;
            margin-top: 2vh;
            opacity: 0;
            animation: rotateIn 2s forwards 1s;
        }

        @keyframes rotateIn {
            0% {
                transform: rotateY(0deg) scale(0.2);
                opacity: 0;
            }
            100% {
                transform: rotateY(360deg) scale(1);
                opacity: 1;
            }
        }

        .ok-button {
            margin-top: 3vh;
            font-size: 1.5rem;
            padding: 0.7rem 2rem;
            background: #88b04b;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 1s ease 1.5s, background-color 0.3s ease;
        }

        .ok-button:hover {
            background: #6b8f39;
        }

        /* „É°„Ç§„É≥ÁîªÈù¢„ÅÆ„Çπ„Çø„Ç§„É´ */
        .main-content {
            display: none; /* ÂàùÊúü„ÅØÈùûË°®Á§∫ */
            width: 100%;
            height: 100%;
            position: relative;
        }

        .headline {
            position: absolute;
            top: 40%;
            left: 50%;
            display: none;
            transform: translateX(-50%);
            color: #fff;
            font-size: 1.4rem;
            text-align: center;
            text-shadow: 0 0 5px #5c5045;
            font-weight: bold;
            white-space: nowrap;
            max-width: 100vw;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .animal-info {
            position: absolute;
            top: 5vh;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: white;
            text-shadow: 0 0 5px #4b463e;
            max-width: 90vw;
            font-size: 4.5vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .animal-info.visible {
            opacity: 1;
        }

        .animal-info .title {
            font-size: 5.5vw;
            font-weight: bold;
        }

        .animal-info .description {
            font-size: 3.5vw;
            margin-top: 0.5vh;
        }

        .animal-image {
            width: 40vw;
            max-width: 200px;
            height: auto;
            margin-top: 1vh;
        }

        @media (min-width: 768px) {
            .animal-info .title {
                font-size: 2rem;
            }

            .animal-info .description {
                font-size: 1.2rem;
            }

            .animal-image {
                width: 150px;
            }
        }

        .card-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: flex-end;
            position: absolute;
            bottom: 0;
            right: 0;
            padding: 2rem;
        }

        .card-button {
            width: 90vw;
            max-width: 400px;
            height: auto;
            position: relative;
            padding: 0;
            margin: 0;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.0rem;
        }

        .card-button img {
            display: block;
            width: 50%;
            height: 50%;
            transition: transform 0.3s ease, filter 0.3s ease;
        }

        .card-button:hover img {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        .card-label {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #280508;
            font-weight: bold;
            pointer-events: none;
            user-select: none;
            font-size: 50%;
            transition: transform 0.3s ease, filter 0.3s ease;
        }

        .card-button:hover .card-label {
            transform: translate(-50%, -50%) scale(1.05);
            filter: brightness(1.1);
        }

        .card-button.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .confirmation-content {
            background: #ede6d0;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 90vw;
        }

        .confirmation-text {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .confirmation-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .confirm-btn, .cancel-btn {
            padding: 0.8rem 2rem;
            font-size: 1.2rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .confirm-btn {
            background: #88b04b;
            color: white;
        }

        .confirm-btn:hover {
            background: #6b8f39;
        }

        .cancel-btn {
            background: #a93f2c;
            color: white;
        }

        .cancel-btn:hover {
            background: #8b2e1f;
        }

        .status-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.8rem;
            text-shadow: 0 0 5px #4b463e;
            white-space: nowrap;
        }

        .players-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            z-index: 100;
            max-width: 300px;
        }

        .players-info h3 {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }

        .player-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            gap: 10px;
        }

        .player-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745; /* Connected */
        }

        .player-status.ready {
            background: #17a2b8; /* Ready for action select */
        }

        .player-status.action_selected {
            background: #007bff; /* Action selected */
        }

        .player-status.action_selected_forced {
            background: #6f42c1; /* Forced selection */
        }

        .player-status.waiting {
            background: #ffc107; /* Waiting for players */
        }

        .player-status.disconnected {
            background: #dc3545; /* Disconnected */
        }

        .loading-dots {
            display: inline-block;
            width: 20px;
        }

        /* ÈÉ®Â±ãÈÅ∏ÊäûÁîªÈù¢ */
        .room-selection-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.8rem;
            text-shadow: 0 0 5px #4b463e;
            text-align: center;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .room-selection-buttons button,
        .room-input-area button {
            padding: 10px 20px;
            font-size: 1.2rem;
            background: #88b04b;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 5px; /* „Éú„Çø„É≥Èñì„ÅÆ„Çπ„Éö„Éº„Çπ */
        }

        .room-selection-buttons button:hover,
        .room-input-area button:hover {
            background: #6b8f39;
        }

        .room-input-area {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .room-input-area input {
            padding: 10px;
            font-size: 1.2rem;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 250px;
            max-width: 80vw;
            text-align: center;
        }

        .room-code-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px 30px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffdd57; /* ÁõÆÁ´ã„Å§Ëâ≤ */
            text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }

        /* „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ë°®Á§∫ */
        .countdown-timer {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1.8rem;
            font-weight: bold;
            z-index: 100;
            display: none; /* ÂàùÊúü„ÅØÈùûË°®Á§∫ */
        }
    </style>
</head>
<body>
    <div class="overlay"></div>
    
    <div id="connection-status" class="connection-status status-waiting">
        Êé•Á∂ö‰∏≠<span class="loading-dots">...</span>
    </div>

    <div id="room-selection-screen" class="room-selection-screen">
        <p id="room-selection-message">„Çà„ÅÜ„Åì„ÅùÔºÅ</p>
        <div id="room-selection-buttons" class="room-selection-buttons">
            <button id="createRoomButton">ÈÉ®Â±ã„Çí‰ΩúÊàê„Åô„Çã</button>
            <button id="showJoinRoomInputButton">ÈÉ®Â±ã„Å´ÂèÇÂä†„Åô„Çã</button>
        </div>

        <div id="join-room-input-area" class="room-input-area" style="display: none;">
            <input type="text" id="roomIdInput" placeholder="ÈÉ®Â±ã„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ">
            <button id="joinRoomButton">ÂèÇÂä†</button>
            <button id="backToSelectionButton">Êàª„Çã</button>
        </div>
        
        <div id="created-room-display" style="display: none;">
            <p>„ÅÇ„Å™„Åü„ÅÆÈÉ®Â±ã„Ç≥„Éº„Éâ:</p>
            <div id="displayRoomCode" class="room-code-display"></div>
            <p>‰ªñ„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆÂèÇÂä†„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...</p>
            <button id="copyRoomCodeButton">„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº</button>
            <button id="cancelRoomButton">ÈÉ®Â±ã„Çí„Ç≠„É£„É≥„Çª„É´</button>
        </div>

        <div id="waiting-for-players-message" style="display: none;">
            <p id="waiting-message">„Éó„É¨„Ç§„É§„Éº„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô<span class="loading-dots">...</span></p>
        </div>
    </div>

    <div class="animal-reveal" id="animalReveal">
        <div class="top-text">„ÅÇ„Å™„Åü„ÅØ</div>
        <div class="animal-name" id="animalName"></div>
        <div class="top-text">„Åß„Åô</div>
        <img id="animalImage" class="animal-image" src="" alt="ÂãïÁâ©ÁîªÂÉè">
        <div class="animal-desc" id="animalDescription"></div>
        <button class="ok-button" id="okButton" onclick="startMainGame()">OK</button>
    </div>
    
    <div id="mainContent" class="main-content">
        <div id="players-info" class="players-info">
            <h3>„Éó„É¨„Ç§„É§„Éº (<span id="player-count">0</span>/4)</h3>
            <div id="players-list"></div>
        </div>

        <div id="countdown-timer" class="countdown-timer">
            ÊÆã„ÇäÊôÇÈñì: <span id="countdown-time">--</span>
        </div>

        <div id="animal-info" class="animal-info">
            <div class="title">„ÅÇ„Å™„Åü„ÅØ</div>
            <div id="mainAnimalName" class="title"></div>
            <div id="mainAnimalDescription" class="description"></div>
            <img id="mainAnimalImage" src="" alt="ÂãïÁâ©ÁîªÂÉè" class="animal-image" />
        </div>

        <div id="headline" class="headline">Ë≠∞Ë´ñ„Åß‰Ωï„Çí„Åô„ÇãÔºü</div>

        <div id="status-message" class="status-message">„Éó„É¨„Ç§„É§„Éº„ÇíÂæÖÊ©ü‰∏≠</div>

        <div id="card-container" class="card-container" style="display: none;">
            <button class="card-button" data-action-id="1" onclick="showConfirmation(1, 'Ë©±„Çí„Åæ„Å®„ÇÅ„Çã')">
                <img src="UI_BG_useroptionday_ver001.png" />
                <span class="card-label">Ë©±„Çí„Åæ„Å®„ÇÅ„Çã</span>
            </button>
            <button class="card-button" data-action-id="2" onclick="showConfirmation(2, 'ÊÑèË¶ã„ÇíË®Ä„ÅÜ')">
                <img src="UI_BG_useroptionday_ver001.png" />
                <span class="card-label">ÊÑèË¶ã„ÇíË®Ä„ÅÜ</span>
            </button>
            <button class="card-button" data-action-id="3" onclick="showConfirmation(3, '„ÇÑ„Çã„Åπ„Åç„Åì„Å®„Çí‰∏ªÂºµ„Åô„Çã')">
                <img src="UI_BG_useroptionday_ver001.png" />
                <span class="card-label">„ÇÑ„Çã„Åπ„Åç„Åì„Å®„Çí‰∏ªÂºµ„Åô„Çã</span>
            </button>
            <button class="card-button" data-action-id="4" onclick="showConfirmation(4, '„ÅîÈ£Ø„ÇíÈ£ü„Åπ„Çã')">
                <img src="UI_BG_useroptionday_ver001.png" />
                <span class="card-label">„ÅîÈ£Ø„ÇíÈ£ü„Åπ„Çã</span>
            </button>
        </div>
    </div>

    <div id="confirmation-modal" class="confirmation-modal">
        <div class="confirmation-content">
            <div class="confirmation-text">„Åì„Çå„ÅßÊ±∫ÂÆö„Åô„ÇãÔºü</div>
            <div class="confirmation-buttons">
                <button class="confirm-btn" onclick="confirmAction()">Ê±∫ÂÆö</button>
                <button class="cancel-btn" onclick="cancelAction()">„Ç≠„É£„É≥„Çª„É´</button>
            </div>
        </div>
    </div>

    <script>
        // WebSocketÊé•Á∂öË®≠ÂÆöÔºàEC2„ÅÆ„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„Å´Â§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ
        const WS_URL = "wss://ws.dcsaitolab.com"; // EC2„ÅÆ„Éë„Éñ„É™„ÉÉ„ÇØIP„Åæ„Åü„ÅØDNSÂêç„Å´ÁΩÆ„ÅçÊèõ„Åà„Çã
        let socket;
        let userId = null;
        let currentAnimalId = null;
        let assignedRoomId = null; // ÊâÄÂ±û„Åô„ÇãÈÉ®Â±ãID
        let selectedActionId = null;
        let gameState = "initial"; // initial, connecting, room_selection, room_creation_wait, room_join_input, waiting_players, reveal, waiting_for_players_ready, main, discussion

        // ÂãïÁâ©„Éá„Éº„Çø
        const animals = {
            1: { name: "„Ç´„Éê", description: "Ê∞¥Ëæ∫„Å´‰Ωè„ÇÄÂ§ß„Åç„Å™ÂãïÁâ©„Åß„Åô„ÄÇ", image: "CH_kaba_ver001.png" },
            2: { name: "„Ç¶„Çµ„ÇÆ", description: "„Å¥„Çá„Çì„Å¥„ÇáË∑≥„Å≠„ÇãÂèØÊÑõ„ÅÑÂãïÁâ©„Åß„Åô„ÄÇ", image: "CH_usagi_ver001.png" },
            3: { name: "„É¢„É¢„É≥„Ç¨", description: "ÊªëÁ©∫„Åô„ÇãÂ§úË°åÊÄß„ÅÆÂãïÁâ©„Åß„Åô„ÄÇ", image: "CH_momonga_ver001.png" },
            4: { name: "„Éã„Éõ„É≥„Ç∂„É´", description: "Ê∏©Ê≥â„Å´ÂÖ•„Çã„Åì„Å®„ÅßÊúâÂêç„Åß„Åô„ÄÇ", image: "CH_saru_ver001.png" },
        };

        // „Éó„É¨„Ç§„É§„ÉºÁÆ°ÁêÜ
        let players = {}; // „Åì„ÅÆ„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±„ÅØÁèæÂú®„ÅÆÈÉ®Â±ã„ÅÆ„ÇÇ„ÅÆ„Å´ÈôêÂÆö„Åï„Çå„Çã

        // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
        const connectionStatus = document.getElementById("connection-status");

        const roomSelectionScreen = document.getElementById("room-selection-screen");
        const roomSelectionMessage = document.getElementById("room-selection-message");
        const roomSelectionButtons = document.getElementById("room-selection-buttons");
        const createRoomButton = document.getElementById("createRoomButton");
        const showJoinRoomInputButton = document.getElementById("showJoinRoomInputButton");
        const joinRoomInputArea = document.getElementById("join-room-input-area");
        const roomIdInput = document.getElementById("roomIdInput");
        const joinRoomButton = document.getElementById("joinRoomButton");
        const backToSelectionButton = document.getElementById("backToSelectionButton");
        const createdRoomDisplay = document.getElementById("created-room-display");
        const displayRoomCode = document.getElementById("displayRoomCode");
        const copyRoomCodeButton = document.getElementById("copyRoomCodeButton");
        const cancelRoomButton = document.getElementById("cancelRoomButton");
        const waitingForPlayersMessage = document.getElementById("waiting-for-players-message");
        const waitingMessage = document.getElementById("waiting-message");


        const animalReveal = document.getElementById("animalReveal");
        const mainContent = document.getElementById("mainContent");
        const statusMessage = document.getElementById("status-message");
        const cardContainer = document.getElementById("card-container");
        const headline = document.getElementById("headline");
        const confirmationModal = document.getElementById("confirmation-modal");
        const playersInfo = document.getElementById("players-info");
        const playersList = document.getElementById("players-list");
        const playerCount = document.getElementById("player-count");
        const animalInfo = document.getElementById("animal-info");
        const countdownTimer = document.getElementById("countdown-timer");
        const countdownTime = document.getElementById("countdown-time");

        // „É≠„Éº„Éá„Ç£„É≥„Ç∞„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        let dotState = 0;
        let loadingText = ""; // Ê±éÁî®ÁöÑ„Å´‰ΩøÁî®„Åô„Çã„Åü„ÇÅÂàùÊúüÂÄ§„Å™„Åó
        let statusMessageInterval;

        function startLoadingAnimation(element, initialText) {
            loadingText = initialText;
            if (statusMessageInterval) clearInterval(statusMessageInterval);
            statusMessageInterval = setInterval(() => {
                dotState = (dotState + 1) % 4;
                const dots = ".".repeat(dotState);
                if (element) {
                    element.innerHTML = `${initialText}<span class="loading-dots">${dots}</span>`;
                }
            }, 500);
        }

        function stopLoadingAnimation() {
            if (statusMessageInterval) {
                clearInterval(statusMessageInterval);
                statusMessageInterval = null;
            }
        }

        // WebSocketÊé•Á∂ö
        function connectWebSocket() {
            gameState = "connecting";
            try {
                socket = new WebSocket(WS_URL);
                startLoadingAnimation(connectionStatus, "Êé•Á∂ö‰∏≠");
                connectionStatus.style.display = "block"; // Êé•Á∂ö‰∏≠„ÅØË°®Á§∫

                socket.onopen = () => {
                    console.log("‚úÖ WebSocketÊé•Á∂öÂÆå‰∫Ü");
                    connectionStatus.textContent = "Êé•Á∂öÊ∏à„Åø";
                    connectionStatus.className = "connection-status status-connected";
                    stopLoadingAnimation();
                    
                    // Êé•Á∂öÊàêÂäüÂæå„ÄÅÈÉ®Â±ãÈÅ∏ÊäûÁîªÈù¢„ÇíË°®Á§∫
                    roomSelectionScreen.style.display = "flex";
                    roomSelectionMessage.textContent = "„Çà„ÅÜ„Åì„ÅùÔºÅ";
                    roomSelectionButtons.style.display = "block"; // „Éú„Çø„É≥Ë°®Á§∫
                    joinRoomInputArea.style.display = "none"; // ÂèÇÂä†ÂÖ•Âäõ„Ç®„É™„Ç¢ÈùûË°®Á§∫
                    createdRoomDisplay.style.display = "none"; // ‰ΩúÊàêÊ∏à„ÅøÈÉ®Â±ãË°®Á§∫ÈùûË°®Á§∫
                    waitingForPlayersMessage.style.display = "none"; // ÂæÖÊ©ü„É°„ÉÉ„Çª„Éº„Ç∏ÈùûË°®Á§∫

                    gameState = "room_selection"; // ÈÉ®Â±ãÈÅ∏ÊäûÁä∂ÊÖã
                };

                socket.onerror = (error) => {
                    console.error("‚ùå WebSocket„Ç®„É©„Éº:", error);
                    connectionStatus.textContent = "Êé•Á∂ö„Ç®„É©„Éº";
                    connectionStatus.className = "connection-status status-disconnected";
                    roomSelectionMessage.textContent = "Êé•Á∂ö„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÂÜçÊé•Á∂ö„ÇíË©¶„Åø„Åæ„Åô...";
                    roomSelectionScreen.style.display = "flex";
                    roomSelectionButtons.style.display = "none";
                    joinRoomInputArea.style.display = "none";
                    createdRoomDisplay.style.display = "none";
                    waitingForPlayersMessage.style.display = "none";
                    stopLoadingAnimation();
                };

                socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleServerMessage(data);
                    } catch (e) {
                        console.log("üì© „ÉÜ„Ç≠„Çπ„Éà„É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø° (ÈùûÊé®Â•®):", event.data);
                    }
                };

                socket.onclose = (event) => {
                    console.warn("‚ö†Ô∏è WebSocketÊé•Á∂ö„ÅåÈñâ„Åò„Çâ„Çå„Åæ„Åó„Åü„ÄÇ„Ç≥„Éº„Éâ:", event.code, "ÁêÜÁî±:", event.reason);
                    connectionStatus.textContent = "Êé•Á∂öÂàáÊñ≠";
                    connectionStatus.className = "connection-status status-disconnected";
                    
                    if (event.code !== 1000 && !event.wasClean) {
                        roomSelectionMessage.textContent = "„Çµ„Éº„Éê„Éº„Å®„ÅÆÊé•Á∂ö„ÅåÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü„ÄÇÂÜçÊé•Á∂ö„ÇíË©¶„Åø„Åæ„Åô...";
                        roomSelectionScreen.style.display = "flex";
                        roomSelectionButtons.style.display = "none"; // „Éú„Çø„É≥„ÇíÈùûË°®Á§∫
                        joinRoomInputArea.style.display = "none";
                        createdRoomDisplay.style.display = "none";
                        waitingForPlayersMessage.style.display = "none";
                        stopLoadingAnimation();
                        setTimeout(connectWebSocket, 3000); // 3ÁßíÂæå„Å´ÂÜçÊé•Á∂ö„ÇíË©¶Ë°å
                    } else if (event.code === 1000) {
                        roomSelectionMessage.textContent = "„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ";
                        roomSelectionScreen.style.display = "flex";
                        roomSelectionButtons.style.display = "block"; // Êñ∞„Åó„ÅÑ„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã„ÅÆ„Åü„ÇÅ„Éú„Çø„É≥Ë°®Á§∫
                        joinRoomInputArea.style.display = "none";
                        createdRoomDisplay.style.display = "none";
                        waitingForPlayersMessage.style.display = "none";
                        stopLoadingAnimation();
                        assignedRoomId = null; // ÈÉ®Â±ãID„Çí„É™„Çª„ÉÉ„Éà
                    }
                };

            } catch (error) {
                console.error("WebSocketÊé•Á∂öÂ§±Êïó:", error);
                connectionStatus.textContent = "Êé•Á∂öÂ§±Êïó";
                connectionStatus.className = "connection-status status-disconnected";
                roomSelectionMessage.textContent = "Êé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü";
                roomSelectionScreen.style.display = "flex";
                roomSelectionButtons.style.display = "none";
                joinRoomInputArea.style.display = "none";
                createdRoomDisplay.style.display = "none";
                waitingForPlayersMessage.style.display = "none";
                stopLoadingAnimation();
            }
        }

        // ÈÉ®Â±ã‰ΩúÊàê„Éú„Çø„É≥
        createRoomButton.addEventListener("click", () => {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: "create_room" }));
                roomSelectionMessage.textContent = "ÈÉ®Â±ã„Çí‰ΩúÊàê‰∏≠...";
                roomSelectionButtons.style.display = "none";
                joinRoomInputArea.style.display = "none";
                createdRoomDisplay.style.display = "none";
                waitingForPlayersMessage.style.display = "flex"; // ÂæÖÊ©ü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
                startLoadingAnimation(waitingMessage, "ÈÉ®Â±ã„Çí‰ΩúÊàê‰∏≠");
                gameState = "room_creation_wait";
            } else {
                alert("„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
                connectWebSocket(); // ÂÜçÊé•Á∂ö„ÇíË©¶„Åø„Çã
            }
        });

        // „ÄåÈÉ®Â±ã„Å´ÂèÇÂä†„Åô„Çã„Äç„Éú„Çø„É≥ (ÂÖ•Âäõ„Éï„Ç©„Éº„É†Ë°®Á§∫)
        showJoinRoomInputButton.addEventListener("click", () => {
            roomSelectionButtons.style.display = "none";
            joinRoomInputArea.style.display = "flex";
            roomSelectionMessage.textContent = "ÂèÇÂä†„Åô„ÇãÈÉ®Â±ã„ÅÆ„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ";
            roomIdInput.value = ""; // ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
            gameState = "room_join_input";
        });

        // ÈÉ®Â±ãÂèÇÂä†„Éú„Çø„É≥ („Ç≥„Éº„ÉâÂÖ•ÂäõÂæå)
        joinRoomButton.addEventListener("click", () => {
            const roomId = roomIdInput.value.trim();
            if (roomId) {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    assignedRoomId = roomId;
                    socket.send(JSON.stringify({
                        type: "join_room",
                        roomId: roomId
                    }));
                    roomSelectionMessage.textContent = `ÈÉ®Â±ã ${roomId} „Å´ÂèÇÂä†‰∏≠...`;
                    joinRoomInputArea.style.display = "none";
                    waitingForPlayersMessage.style.display = "flex"; // ÂæÖÊ©ü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
                    startLoadingAnimation(waitingMessage, `ÈÉ®Â±ã ${roomId} „Å´ÂèÇÂä†‰∏≠`);
                    gameState = "waiting_players";
                } else {
                    alert("„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ");
                    connectWebSocket();
                }
            } else {
                alert("ÈÉ®Â±ã„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
            }
        });

        // „ÄåÊàª„Çã„Äç„Éú„Çø„É≥ (ÂèÇÂä†ÂÖ•ÂäõÁîªÈù¢„Åã„ÇâÈÅ∏ÊäûÁîªÈù¢„Å∏)
        backToSelectionButton.addEventListener("click", () => {
            roomSelectionButtons.style.display = "block";
            joinRoomInputArea.style.display = "none";
            roomSelectionMessage.textContent = "„Çà„ÅÜ„Åì„ÅùÔºÅ";
            gameState = "room_selection";
        });

        // ÈÉ®Â±ã„Ç≥„Éº„Éâ„Ç≥„Éî„Éº„Éú„Çø„É≥
        copyRoomCodeButton.addEventListener("click", () => {
            const roomCode = displayRoomCode.textContent;
            navigator.clipboard.writeText(roomCode).then(() => {
                alert("ÈÉ®Â±ã„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü: " + roomCode);
            }).catch(err => {
                console.error('ÈÉ®Â±ã„Ç≥„Éº„Éâ„ÅÆ„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', err);
            });
        });
        
        // ÈÉ®Â±ã„Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥ (ÈÉ®Â±ã‰ΩúÊàêËÄÖ„ÅåÈÉ®Â±ã„ÇíÈñâ„Åò„ÇãÂ†¥Âêà)
        cancelRoomButton.addEventListener("click", () => {
             if (socket && socket.readyState === WebSocket.OPEN && assignedRoomId) {
                // „Çµ„Éº„Éê„Éº„Å´ÈÉ®Â±ã„Ç≠„É£„É≥„Çª„É´„ÇíÈÄöÁü•„Åô„Çã„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ„Çã„Åì„Å®„ÇÇÂèØËÉΩ„Å†„Åå„ÄÅ
                // ‰ªäÂõû„ÅØ„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂÅ¥„ÅßÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà„Åó„ÄÅ„Çµ„Éº„Éê„Éº„ÅØÊé•Á∂öÂàáÊñ≠„ÅßÈÉ®Â±ã„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„Åô„ÇãÊÉ≥ÂÆö
                socket.close(1000, "Room creation cancelled by user"); // Ê≠£Â∏∏ÁµÇ‰∫Ü
            }
            // UI„ÇíÂàùÊúüÁä∂ÊÖã„Å´Êàª„Åô
            roomSelectionButtons.style.display = "block";
            createdRoomDisplay.style.display = "none";
            waitingForPlayersMessage.style.display = "none";
            roomSelectionMessage.textContent = "„Çà„ÅÜ„Åì„ÅùÔºÅ";
            stopLoadingAnimation();
            assignedRoomId = null; // ÈÉ®Â±ãID„Çí„É™„Çª„ÉÉ„Éà
            gameState = "room_selection";
            connectWebSocket(); // WebSocket„ÇíÂÜçÊé•Á∂ö„Åó„Å¶Êñ∞„Åó„ÅÑ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÈñãÂßã
        });


        // „Çµ„Éº„Éê„Éº„É°„ÉÉ„Çª„Éº„Ç∏„Éè„É≥„Éâ„É©„Éº
        function handleServerMessage(data) {
            console.log("üì© „Çµ„Éº„Éê„Éº„É°„ÉÉ„Çª„Éº„Ç∏:", data);

            switch (data.type) {
                case "room_created": // ÈÉ®Â±ã‰ΩúÊàêÊàêÂäü
                    assignedRoomId = data.roomId;
                    displayRoomCode.textContent = data.roomId;
                    roomSelectionScreen.style.display = "flex";
                    roomSelectionButtons.style.display = "none";
                    joinRoomInputArea.style.display = "none";
                    createdRoomDisplay.style.display = "block"; // ‰ΩúÊàêÊ∏à„ÅøÈÉ®Â±ãË°®Á§∫
                    waitingForPlayersMessage.style.display = "block"; // ÂæÖÊ©ü„É°„ÉÉ„Çª„Éº„Ç∏
                    stopLoadingAnimation();
                    startLoadingAnimation(waitingMessage, "‰ªñ„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆÂèÇÂä†„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô");
                    gameState = "waiting_players"; // „Éó„É¨„Ç§„É§„ÉºÂæÖ„Å°Áä∂ÊÖã
                    break;

                case "user_assigned": // „Éó„É¨„Ç§„É§„ÉºÂÖ®Âì°„ÅåÊèÉ„Å£„ÅüÂæå„ÄÅÂãïÁâ©„ÅåÂâ≤„ÇäÊåØ„Çâ„Çå„ÅüÈÄöÁü•
                    userId = data.userId;
                    currentAnimalId = data.animalId;
                    assignedRoomId = data.roomId; // Âøµ„ÅÆ„Åü„ÇÅÂÜçÂ∫¶ÂèñÂæó
                    updateAnimalDisplay(currentAnimalId);
                    showAnimalReveal(); // ÂãïÁâ©ÂÖ¨ÈñãÁîªÈù¢„Å∏ÈÅ∑Áßª
                    break;

                case "players_update":
                    players = data.players;
                    updatePlayersDisplay();
                    break;

                case "game_start_preparation": // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Å´ÂãïÁâ©ÂÖ¨ÈñãÂæå„ÅÆÊ∫ñÂÇô„Çí‰øÉ„Åô
                    console.log("„Ç≤„Éº„É†ÈñãÂßãÊ∫ñÂÇô„Ç∑„Ç∞„Éä„É´„ÇíÂèó‰ø°„Åó„Åæ„Åó„Åü„ÄÇ");
                    break;

                case "game_phase":
                    handleGamePhase(data.phase, data.data);
                    break;

                case "countdown":
                    updateCountdownDisplay(data.time);
                    break;

                case "waiting_for_actions":
                    headline.textContent = "‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...";
                    startLoadingAnimation(statusMessage, "‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô");
                    cardContainer.style.display = "none";
                    statusMessage.style.display = "block";
                    countdownTimer.style.display = "none";
                    break;

                case "error":
                    console.error("„Çµ„Éº„Éê„Éº„Ç®„É©„Éº:", data.message);
                    alert("„Ç®„É©„Éº: " + data.message);
                    // „Ç®„É©„ÉºÁô∫ÁîüÊôÇ„ÅØÈÉ®Â±ãÈÅ∏ÊäûÁîªÈù¢„Å´Êàª„Çã
                    roomSelectionScreen.style.display = "flex";
                    roomSelectionMessage.textContent = `„Ç®„É©„Éº: ${data.message} ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ`;
                    roomSelectionButtons.style.display = "block";
                    joinRoomInputArea.style.display = "none";
                    createdRoomDisplay.style.display = "none";
                    waitingForPlayersMessage.style.display = "none";
                    animalReveal.style.display = "none";
                    mainContent.style.display = "none";
                    stopLoadingAnimation();
                    assignedRoomId = null; // ÈÉ®Â±ãID„Çí„É™„Çª„ÉÉ„Éà
                    gameState = "room_selection";
                    break;
            }
        }

        // ÂãïÁâ©Ë°®Á§∫Êõ¥Êñ∞
        function updateAnimalDisplay(animalId) {
            const animal = animals[animalId];
            if (!animal) return;

            document.getElementById("animalName").textContent = animal.name;
            document.getElementById("animalDescription").textContent = animal.description;
            document.getElementById("animalImage").src = animal.image;

            document.getElementById("mainAnimalName").textContent = animal.name;
            document.getElementById("mainAnimalDescription").textContent = animal.description;
            document.getElementById("mainAnimalImage").src = animal.image;

            animalInfo.classList.add("visible");
        }

        // ÂãïÁâ©Ê±∫ÂÆöÁîªÈù¢„ÇíË°®Á§∫„Åó„ÄÅ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÈñãÂßã
        function showAnimalReveal() {
            gameState = "reveal";
            roomSelectionScreen.style.display = "none";
            animalReveal.style.display = "block";
            mainContent.style.display = "none";
            
            setTimeout(() => {
                animalReveal.classList.add("show");
            }, 500);
        }

        // „É°„Ç§„É≥„Ç≤„Éº„É†ÁîªÈù¢„Å´Âàá„ÇäÊõø„Åà (OK„Éú„Çø„É≥„ÅåÊäº„Åï„Çå„ÅüÂæå)
        function startMainGame() {
            gameState = "waiting_for_players_ready";
            animalReveal.style.display = "none";
            mainContent.style.display = "block";
            countdownTimer.style.display = "none";
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: "ready_for_game",
                    userId: userId,
                    roomId: assignedRoomId
                }));
            }

            statusMessage.style.display = "block";
            startLoadingAnimation(statusMessage, "‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô");
            headline.style.display = "none";
            cardContainer.style.display = "none";

            playersInfo.style.display = "block";
        }

        // „Éó„É¨„Ç§„É§„ÉºË°®Á§∫Êõ¥Êñ∞
        function updatePlayersDisplay() {
            const count = Object.keys(players).length;
            playerCount.textContent = count;
            
            playersList.innerHTML = "";
            for (const playerId in players) {
                const player = players[playerId];
                const playerDiv = document.createElement("div");
                playerDiv.className = "player-item";
                
                const statusDiv = document.createElement("div");
                statusDiv.className = `player-status ${player.status}`;
                
                const nameDiv = document.createElement("div");
                const isMe = (player.userId === userId) ? " („ÅÇ„Å™„Åü)" : "";
                nameDiv.textContent = `${animals[player.animalId]?.name || "Êú™ÂÆö"} („Éó„É¨„Ç§„É§„Éº${player.userId.split('_')[1]})${isMe}`;
                
                playerDiv.appendChild(statusDiv);
                playerDiv.appendChild(nameDiv);
                playersList.appendChild(playerDiv);
            }
        }

        // „Ç≤„Éº„É†„Éï„Çß„Éº„Ç∫Âá¶ÁêÜ
        function handleGamePhase(phase, data) {
            console.log(`„Éï„Çß„Éº„Ç∫Â§âÊõ¥: ${phase}`, data);
            switch (phase) {
                case "discussion":
                    stopLoadingAnimation();
                    headline.textContent = "Ë≠∞Ë´ñ‰∏≠";
                    headline.style.display = "block";
                    cardContainer.style.display = "none";
                    statusMessage.style.display = "none";
                    countdownTimer.style.display = "none";
                    break;
                    
                case "story_progress":
                    stopLoadingAnimation();
                    headline.textContent = "„Çπ„Éà„Éº„É™„ÉºÈÄ≤Ë°å‰∏≠";
                    headline.style.display = "block";
                    cardContainer.style.display = "none";
                    statusMessage.style.display = "none";
                    countdownTimer.style.display = "none";
                    break;
                    
                case "action_select":
                    if (gameState === "waiting_for_players_ready" || gameState === "main") {
                        startGameplay();
                        countdownTimer.style.display = "block";
                        statusMessage.style.display = "none";
                    }
                    break;
            }
        }

        // „Ç≤„Éº„É†„Éó„É¨„Ç§ÈñãÂßã („Ç¢„ÇØ„Ç∑„Éß„É≥ÈÅ∏Êäû„Éï„Çß„Éº„Ç∫)
        function startGameplay() {
            cardContainer.style.display = "flex";
            statusMessage.style.display = "none";
            stopLoadingAnimation();
            headline.style.display = "block";
            headline.textContent = "Ë≠∞Ë´ñ„Åß‰Ωï„Çí„Åô„ÇãÔºü";
            
            document.querySelectorAll('.card-button').forEach(btn => {
                btn.classList.remove('disabled');
            });
        }

        // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ë°®Á§∫„ÇíÊõ¥Êñ∞
        function updateCountdownDisplay(time) {
            countdownTime.textContent = time;
            if (time <= 5 && time > 0) {
                countdownTime.style.color = "red";
            } else {
                countdownTime.style.color = "white";
            }
            if (time <= 0) {
                document.querySelectorAll('.card-button').forEach(btn => {
                    btn.classList.add('disabled');
                });
                headline.textContent = "ÊôÇÈñì„ÅåÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...";
                startLoadingAnimation(statusMessage, "‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô");
                cardContainer.style.display = "none";
                statusMessage.style.display = "block";
            }
        }

        // „Ç¢„ÇØ„Ç∑„Éß„É≥ÈÄÅ‰ø°
        function send(actionId) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({ 
                    type: "action",
                    userId: userId,
                    roomId: assignedRoomId,
                    actionId: actionId,
                    timestamp: Date.now()
                });
                socket.send(message);
                console.log("üì§ ÈÄÅ‰ø°:", message);
            } else {
                console.warn("‚õî WebSocket„ÅåÊú™Êé•Á∂ö„ÄÇÂÜçÊé•Á∂ö„ÇíË©¶„Åø„Åæ„Åô...");
                connectWebSocket();
            }
        }

        // Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showConfirmation(actionId, actionName) {
            selectedActionId = actionId;
            confirmationModal.style.display = "flex";
        }

        // „Ç¢„ÇØ„Ç∑„Éß„É≥Á¢∫ÂÆö
        function confirmAction() {
            if (selectedActionId !== null) {
                document.querySelectorAll('.card-button').forEach(btn => {
                    btn.classList.add('disabled');
                });

                headline.textContent = "‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...";
                startLoadingAnimation(statusMessage, "‰ªñ„ÅÆ„É¶„Éº„Ç∂„Éº„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô");
                cardContainer.style.display = "none";
                statusMessage.style.display = "block";
                countdownTimer.style.display = "none";

                send(selectedActionId);
                confirmationModal.style.display = "none";
                selectedActionId = null;
            }
        }

        // „Ç¢„ÇØ„Ç∑„Éß„É≥„Ç≠„É£„É≥„Çª„É´
        function cancelAction() {
            selectedActionId = null;
            confirmationModal.style.display = "none";
        }

        // ÂàùÊúüÂåñ
        window.onload = () => {
            connectWebSocket(); // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´WebSocketÊé•Á∂ö„ÇíÈñãÂßã
            roomSelectionScreen.style.display = "none"; // ÂàùÊúü„ÅØÈÉ®Â±ãÈÅ∏ÊäûÁîªÈù¢„ÇÇÈùûË°®Á§∫
            animalReveal.style.display = "none";
            mainContent.style.display = "none";
            connectionStatus.style.display = "block"; // Êé•Á∂ö‰∏≠„É°„ÉÉ„Çª„Éº„Ç∏„ÅØË°®Á§∫
        };
        
        window.onbeforeunload = () => {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.close(1000, "User closed the page");
            }
            stopLoadingAnimation();
        };
    </script>
</body>
</html>
