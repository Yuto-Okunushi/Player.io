<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹•ç‰©è­°è«–ã‚²ãƒ¼ãƒ </title>
    <style>
        /* æ—¢å­˜ã®CSSã¯ãã®ã¾ã¾ */
        body {
            margin: 0;
            padding: 0;
            background-image: url('18.png');
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        .overlay {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: url('17.png');
            background-repeat: repeat;
            background-size: 1500px auto;
            transform: rotate(45deg);
            opacity: 0.2;
            animation: diagonalScroll 40s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes diagonalScroll {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 100% 200%;
            }
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 100;
        }

        .status-connected {
            background: rgba(40, 167, 69, 0.8);
        }

        .status-waiting {
            background: rgba(255, 193, 7, 0.8);
        }

        .status-disconnected {
            background: rgba(220, 53, 69, 0.8);
        }

        /* å‹•ç‰©æ±ºå®šç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå‚è€ƒãƒ‡ã‚¶ã‚¤ãƒ³ã«åŸºã¥ãï¼‰ */
        .animal-reveal {
            text-align: center;
            color: white;
            text-shadow: 0 0 5px #4b463e;
            position: absolute;
            top: 20vh;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: rgba(0, 0, 0, 0.1);
            padding: 1rem 2rem;
            border-radius: 12px;
            max-width: 90vw;
            user-select: none;
            display: none; /* åˆæœŸã¯éè¡¨ç¤º */
        }

        .animal-reveal .top-text {
            font-size: 2rem;
            margin-bottom: 1vh;
        }

        .animal-reveal .animal-name {
            font-size: 2.5rem;
            font-weight: bold;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 1s ease, transform 1s ease;
        }

        .animal-reveal.show .animal-name,
        .animal-reveal.show .animal-image,
        .animal-reveal.show .animal-desc,
        .animal-reveal.show .ok-button {
            opacity: 1;
            transform: translateY(0);
        }

        .animal-reveal .animal-desc {
            font-size: 2rem;
            margin-top: 1vh;
            opacity: 0;
            transition: opacity 1s ease 0.5s, transform 1s ease 0.5s;
        }

        .animal-reveal .animal-image {
            width: 50vw;
            max-width: 220px;
            margin-top: 2vh;
            opacity: 0;
            animation: rotateIn 2s forwards 1s;
        }

        @keyframes rotateIn {
            0% {
                transform: rotateY(0deg) scale(0.2);
                opacity: 0;
            }
            100% {
                transform: rotateY(360deg) scale(1);
                opacity: 1;
            }
        }

        .ok-button {
            margin-top: 3vh;
            font-size: 1.5rem;
            padding: 0.7rem 2rem;
            background: #88b04b;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 1s ease 1.5s, background-color 0.3s ease;
        }

        .ok-button:hover {
            background: #6b8f39;
        }

        /* ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .main-content {
            display: none; /* åˆæœŸã¯éè¡¨ç¤º */
            width: 100%;
            height: 100%;
            position: relative;
        }

        .headline {
            position: absolute;
            top: 40%;
            left: 50%;
            display: none;
            transform: translateX(-50%);
            color: #fff;
            font-size: 1.4rem;
            text-align: center;
            text-shadow: 0 0 5px #5c5045;
            font-weight: bold;
            white-space: nowrap;
            max-width: 100vw;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .animal-info {
            position: absolute;
            top: 5vh;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: white;
            text-shadow: 0 0 5px #4b463e;
            max-width: 90vw;
            font-size: 4.5vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .animal-info.visible {
            opacity: 1;
        }

        .animal-info .title {
            font-size: 5.5vw;
            font-weight: bold;
        }

        .animal-info .description {
            font-size: 3.5vw;
            margin-top: 0.5vh;
        }

        .animal-image {
            width: 40vw;
            max-width: 200px;
            height: auto;
            margin-top: 1vh;
        }

        @media (min-width: 768px) {
            .animal-info .title {
                font-size: 2rem;
            }

            .animal-info .description {
                font-size: 1.2rem;
            }

            .animal-image {
                width: 150px;
            }
        }

        .card-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: flex-end;
            position: absolute;
            bottom: 0;
            right: 0;
            padding: 2rem;
        }

        .card-button {
            width: 90vw;
            max-width: 400px;
            height: auto;
            position: relative;
            padding: 0;
            margin: 0;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.0rem;
        }

        .card-button img {
            display: block;
            width: 50%;
            height: 50%;
            transition: transform 0.3s ease, filter 0.3s ease;
        }

        .card-button:hover img {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        .card-label {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #280508;
            font-weight: bold;
            pointer-events: none;
            user-select: none;
            font-size: 50%;
            transition: transform 0.3s ease, filter 0.3s ease;
        }

        .card-button:hover .card-label {
            transform: translate(-50%, -50%) scale(1.05);
            filter: brightness(1.1);
        }

        .card-button.disabled {
            opacity: 0.3;
            pointer-events: none;
        }

        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .confirmation-content {
            background: #ede6d0;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 90vw;
        }

        .confirmation-text {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #333;
        }

        .confirmation-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .confirm-btn, .cancel-btn {
            padding: 0.8rem 2rem;
            font-size: 1.2rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .confirm-btn {
            background: #88b04b;
            color: white;
        }

        .confirm-btn:hover {
            background: #6b8f39;
        }

        .cancel-btn {
            background: #a93f2c;
            color: white;
        }

        .cancel-btn:hover {
            background: #8b2e1f;
        }

        .status-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.8rem;
            text-shadow: 0 0 5px #4b463e;
            white-space: nowrap;
        }

        .players-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            z-index: 100;
            max-width: 300px;
        }

        .players-info h3 {
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }

        .player-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            gap: 10px;
        }

        .player-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745; /* Connected */
        }

        .player-status.ready {
            background: #17a2b8; /* Ready for action select */
        }

        .player-status.action_selected {
            background: #007bff; /* Action selected */
        }

        .player-status.action_selected_forced {
            background: #6f42c1; /* Forced selection */
        }

        .player-status.waiting {
            background: #ffc107; /* Waiting for players */
        }

        .player-status.disconnected {
            background: #dc3545; /* Disconnected */
        }

        .loading-dots {
            display: inline-block;
            width: 20px;
        }

        /* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢ */
        .password-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.8rem;
            text-shadow: 0 0 5px #4b463e;
            text-align: center;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* åˆæœŸè¡¨ç¤º */
        }

        .password-input-area {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .password-input-area input {
            padding: 10px;
            font-size: 1.2rem;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 250px;
            max-width: 80vw;
            text-align: center;
        }

        .password-input-area button {
            padding: 10px 20px;
            font-size: 1.2rem;
            background: #88b04b;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .password-input-area button:hover {
            background: #6b8f39;
        }


        /* æ¥ç¶šå¾…æ©Ÿç”»é¢ (éƒ¨å±‹IDå…¥åŠ›ã‚’å«ã‚€) */
        .waiting-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.8rem;
            text-shadow: 0 0 5px #4b463e;
            text-align: center;
            z-index: 10;
            display: flex; /* Flexboxã«å¤‰æ›´ã—ã¦è¦ç´ ã‚’ä¸­å¤®ã«é…ç½®ã—ã‚„ã™ãã™ã‚‹ */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            display: none; /* åˆæœŸã¯éè¡¨ç¤º */
        }

        .room-input-area {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .room-input-area input {
            padding: 10px;
            font-size: 1.2rem;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 250px; /* å°‘ã—åºƒã‚ã« */
            max-width: 80vw;
            text-align: center;
        }

        .room-input-area button {
            padding: 10px 20px;
            font-size: 1.2rem;
            background: #88b04b;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .room-input-area button:hover {
            background: #6b8f39;
        }


        /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º */
        .countdown-timer {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1.8rem;
            font-weight: bold;
            z-index: 100;
            display: none; /* åˆæœŸã¯éè¡¨ç¤º */
        }
    </style>
</head>
<body>
    <div class="overlay"></div>
    
    <div id="connection-status" class="connection-status status-waiting">
        æ¥ç¶šä¸­<span class="loading-dots">...</span>
    </div>

    <div id="password-screen" class="password-screen">
        <p id="password-message">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <div class="password-input-area">
            <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <button id="submitPasswordButton">é€ä¿¡</button>
        </div>
    </div>

    <div id="waiting-screen" class="waiting-screen">
        <p id="waiting-message">ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šä¸­<span class="loading-dots">...</span></p>
        <div id="room-input-area" class="room-input-area" style="display: none;">
            <input type="text" id="roomIdInput" placeholder="éƒ¨å±‹IDã‚’å…¥åŠ›">
            <button id="joinRoomButton">éƒ¨å±‹ã«å‚åŠ </button>
        </div>
    </div>

    <div class="animal-reveal" id="animalReveal">
        <div class="top-text">ã‚ãªãŸã¯</div>
        <div class="animal-name" id="animalName"></div>
        <div class="top-text">ã§ã™</div>
        <img id="animalImage" class="animal-image" src="" alt="å‹•ç‰©ç”»åƒ">
        <div class="animal-desc" id="animalDescription"></div>
        <button class="ok-button" id="okButton" onclick="startMainGame()">OK</button>
    </div>
    
    <div id="mainContent" class="main-content">
        <div id="players-info" class="players-info">
            <h3>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ (<span id="player-count">0</span>/4)</h3>
            <div id="players-list"></div>
        </div>

        <div id="countdown-timer" class="countdown-timer">
            æ®‹ã‚Šæ™‚é–“: <span id="countdown-time">--</span>
        </div>

        <div id="animal-info" class="animal-info">
            <div class="title">ã‚ãªãŸã¯</div>
            <div id="mainAnimalName" class="title"></div>
            <div id="mainAnimalDescription" class="description"></div>
            <img id="mainAnimalImage" src="" alt="å‹•ç‰©ç”»åƒ" class="animal-image" />
        </div>

        <div id="headline" class="headline">è­°è«–ã§ä½•ã‚’ã™ã‚‹ï¼Ÿ</div>

        <div id="status-message" class="status-message">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å¾…æ©Ÿä¸­</div>

        <div id="card-container" class="card-container" style="display: none;">
            <button class="card-button" data-action-id="1" onclick="showConfirmation(1, 'è©±ã‚’ã¾ã¨ã‚ã‚‹')">
                <img src="UI_BG_useroptionday_ver001.png" />
                <span class="card-label">è©±ã‚’ã¾ã¨ã‚ã‚‹</span>
            </button>
            <button class="card-button" data-action-id="2" onclick="showConfirmation(2, 'æ„è¦‹ã‚’è¨€ã†')">
                <img src="UI_BG_useroptionday_ver001.png" />
                <span class="card-label">æ„è¦‹ã‚’è¨€ã†</span>
            </button>
            <button class="card-button" data-action-id="3" onclick="showConfirmation(3, 'ã‚„ã‚‹ã¹ãã“ã¨ã‚’ä¸»å¼µã™ã‚‹')">
                <img src="UI_BG_useroptionday_ver001.png" />
                <span class="card-label">ã‚„ã‚‹ã¹ãã“ã¨ã‚’ä¸»å¼µã™ã‚‹</span>
            </button>
            <button class="card-button" data-action-id="4" onclick="showConfirmation(4, 'ã”é£¯ã‚’é£Ÿã¹ã‚‹')">
                <img src="UI_BG_useroptionday_ver001.png" />
                <span class="card-label">ã”é£¯ã‚’é£Ÿã¹ã‚‹</span>
            </button>
        </div>
    </div>

    <div id="confirmation-modal" class="confirmation-modal">
        <div class="confirmation-content">
            <div class="confirmation-text">ã“ã‚Œã§æ±ºå®šã™ã‚‹ï¼Ÿ</div>
            <div class="confirmation-buttons">
                <button class="confirm-btn" onclick="confirmAction()">æ±ºå®š</button>
                <button class="cancel-btn" onclick="cancelAction()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        // WebSocketæ¥ç¶šè¨­å®šï¼ˆEC2ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
        const WS_URL = "wss://ws.dcsaitolab.com"; // EC2ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã¾ãŸã¯DNSåã«ç½®ãæ›ãˆã‚‹
        let socket;
        let userId = null;
        let currentAnimalId = null;
        let assignedRoomId = null; // æ‰€å±ã™ã‚‹éƒ¨å±‹ID
        let selectedActionId = null;
        let gameState = "initial"; // initial, connecting, waiting_room, reveal, waiting_for_players_ready, main, discussion

        // å‹•ç‰©ãƒ‡ãƒ¼ã‚¿
        const animals = {
            1: { name: "ã‚«ãƒ", description: "æ°´è¾ºã«ä½ã‚€å¤§ããªå‹•ç‰©ã§ã™ã€‚", image: "CH_kaba_ver001.png" },
            2: { name: "ã‚¦ã‚µã‚®", description: "ã´ã‚‡ã‚“ã´ã‚‡è·³ã­ã‚‹å¯æ„›ã„å‹•ç‰©ã§ã™ã€‚", image: "CH_usagi_ver001.png" },
            3: { name: "ãƒ¢ãƒ¢ãƒ³ã‚¬", description: "æ»‘ç©ºã™ã‚‹å¤œè¡Œæ€§ã®å‹•ç‰©ã§ã™ã€‚", image: "CH_momonga_ver001.png" },
            4: { name: "ãƒ‹ãƒ›ãƒ³ã‚¶ãƒ«", description: "æ¸©æ³‰ã«å…¥ã‚‹ã“ã¨ã§æœ‰åã§ã™ã€‚", image: "CH_saru_ver001.png" },
        };

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†
        let players = {}; // ã“ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã¯ç¾åœ¨ã®éƒ¨å±‹ã®ã‚‚ã®ã«é™å®šã•ã‚Œã‚‹

        // DOMè¦ç´ ã®å–å¾—
        const connectionStatus = document.getElementById("connection-status");
        const passwordScreen = document.getElementById("password-screen"); // è¿½åŠ 
        const passwordInput = document.getElementById("passwordInput");     // è¿½åŠ 
        const submitPasswordButton = document.getElementById("submitPasswordButton"); // è¿½åŠ 
        const passwordMessage = document.getElementById("password-message"); // è¿½åŠ 

        const waitingScreen = document.getElementById("waiting-screen");
        const waitingMessage = document.getElementById("waiting-message");
        const roomInputArea = document.getElementById("room-input-area");
        const roomIdInput = document.getElementById("roomIdInput");
        const joinRoomButton = document.getElementById("joinRoomButton");

        const animalReveal = document.getElementById("animalReveal");
        const mainContent = document.getElementById("mainContent");
        const statusMessage = document.getElementById("status-message");
        const cardContainer = document.getElementById("card-container");
        const headline = document.getElementById("headline");
        const confirmationModal = document.getElementById("confirmation-modal");
        const playersInfo = document.getElementById("players-info");
        const playersList = document.getElementById("players-list");
        const playerCount = document.getElementById("player-count");
        const animalInfo = document.getElementById("animal-info");
        const countdownTimer = document.getElementById("countdown-timer");
        const countdownTime = document.getElementById("countdown-time");

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        let dotState = 0;
        let loadingText = ""; // æ±ç”¨çš„ã«ä½¿ç”¨ã™ã‚‹ãŸã‚åˆæœŸå€¤ãªã—
        let statusMessageInterval;

        function startLoadingAnimation(element, initialText) {
            loadingText = initialText;
            if (statusMessageInterval) clearInterval(statusMessageInterval);
            statusMessageInterval = setInterval(() => {
                dotState = (dotState + 1) % 4;
                const dots = ".".repeat(dotState);
                if (element) {
                    element.innerHTML = `${initialText}<span class="loading-dots">${dots}</span>`;
                }
            }, 500);
        }

        function stopLoadingAnimation() {
            if (statusMessageInterval) {
                clearInterval(statusMessageInterval);
                statusMessageInterval = null;
            }
        }

        // WebSocketæ¥ç¶š
        function connectWebSocket() {
            gameState = "connecting";
            try {
                socket = new WebSocket(WS_URL);
                startLoadingAnimation(connectionStatus, "æ¥ç¶šä¸­");
                // æ¥ç¶šä¸­ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”»é¢ã‚‚éè¡¨ç¤ºã«
                passwordScreen.style.display = "none";

                socket.onopen = () => {
                    console.log("âœ… WebSocketæ¥ç¶šå®Œäº†");
                    connectionStatus.textContent = "æ¥ç¶šæ¸ˆã¿";
                    connectionStatus.className = "connection-status status-connected";
                    stopLoadingAnimation();
                    
                    // æ¥ç¶šæˆåŠŸå¾Œã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”»é¢ã‚’è¡¨ç¤º
                    passwordScreen.style.display = "flex";
                    passwordMessage.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
                    gameState = "password_entry"; // æ–°ã—ã„çŠ¶æ…‹
                };

                socket.onerror = (error) => {
                    console.error("âŒ WebSocketã‚¨ãƒ©ãƒ¼:", error);
                    connectionStatus.textContent = "æ¥ç¶šã‚¨ãƒ©ãƒ¼";
                    connectionStatus.className = "connection-status status-disconnected";
                    passwordMessage.textContent = "æ¥ç¶šã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™...";
                    passwordScreen.style.display = "flex"; // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”»é¢ã‚’è¡¨ç¤º
                    stopLoadingAnimation();
                };

                socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleServerMessage(data);
                    } catch (e) {
                        console.log("ğŸ“© ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ (éæ¨å¥¨):", event.data);
                    }
                };

                // å†æ¥ç¶šå‡¦ç†ã‚’å¼·åŒ– (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®å†ãƒ­ãƒ¼ãƒ‰ã‚’é¿ã‘ã‚‹ãŸã‚)
                socket.onclose = (event) => {
                    console.warn("âš ï¸ WebSocketæ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸã€‚ã‚³ãƒ¼ãƒ‰:", event.code, "ç†ç”±:", event.reason);
                    connectionStatus.textContent = "æ¥ç¶šåˆ‡æ–­";
                    connectionStatus.className = "connection-status status-disconnected";
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ„å›³çš„ã«ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ãŸå ´åˆã‚’é™¤ãã€è‡ªå‹•å†æ¥ç¶š
                    // event.code === 1000 ã¯æ­£å¸¸çµ‚äº†
                    if (event.code !== 1000 && !event.wasClean) {
                        passwordMessage.textContent = "ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™...";
                        passwordScreen.style.display = "flex"; // åˆ‡æ–­æ™‚ã‚‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”»é¢ã«æˆ»ã‚‹
                        waitingScreen.style.display = "none"; // éƒ¨å±‹é¸æŠç”»é¢ã¯éè¡¨ç¤º
                        stopLoadingAnimation();
                        setTimeout(connectWebSocket, 3000); // 3ç§’å¾Œã«å†æ¥ç¶šã‚’è©¦è¡Œ
                    } else if (event.code === 1000) {
                        // æ­£å¸¸çµ‚äº†ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ã‹ã€çµ‚äº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                        passwordMessage.textContent = "ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                        passwordScreen.style.display = "flex"; // æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã®ãŸã‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”»é¢ã«æˆ»ã‚‹
                        waitingScreen.style.display = "none";
                        stopLoadingAnimation();
                    }
                };

            } catch (error) {
                console.error("WebSocketæ¥ç¶šå¤±æ•—:", error);
                connectionStatus.textContent = "æ¥ç¶šå¤±æ•—";
                connectionStatus.className = "connection-status status-disconnected";
                passwordMessage.textContent = "æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ";
                passwordScreen.style.display = "flex";
                stopLoadingAnimation();
            }
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é€ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        submitPasswordButton.addEventListener("click", () => {
            const password = passwordInput.value.trim();
            if (password) {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: "authenticate", // èªè¨¼ç”¨ã®æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—
                        password: password,
                        timestamp: Date.now()
                    }));
                    passwordMessage.textContent = "èªè¨¼ä¸­...";
                    passwordInput.disabled = true;
                    submitPasswordButton.disabled = true;
                    startLoadingAnimation(passwordMessage, "èªè¨¼ä¸­");
                } else {
                    alert("WebSocketãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™ã€‚");
                    connectWebSocket();
                }
            } else {
                alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            }
        });

        // éƒ¨å±‹å‚åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        joinRoomButton.addEventListener("click", () => {
            const roomId = roomIdInput.value.trim();
            if (roomId) {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    assignedRoomId = roomId; // ã“ã“ã§éƒ¨å±‹IDã‚’ä¿æŒ
                    socket.send(JSON.stringify({
                        type: "join_room", // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¿ã‚¤ãƒ—
                        roomId: roomId,
                        timestamp: Date.now()
                    }));
                    waitingMessage.textContent = `éƒ¨å±‹ ${roomId} ã«å‚åŠ ä¸­...`;
                    roomInputArea.style.display = "none";
                    startLoadingAnimation(waitingMessage, `éƒ¨å±‹ ${roomId} ã«å‚åŠ ä¸­`);
                    gameState = "waiting_players"; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å¾…ã¡çŠ¶æ…‹
                } else {
                    alert("WebSocketãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™ã€‚");
                    connectWebSocket(); // å†æ¥ç¶šã‚’è©¦ã¿ã‚‹
                }
            } else {
                alert("éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            }
        });


        // ã‚µãƒ¼ãƒãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function handleServerMessage(data) {
            console.log("ğŸ“© ã‚µãƒ¼ãƒãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:", data);

            switch (data.type) {
                case "authenticated": // èªè¨¼æˆåŠŸ
                    passwordScreen.style.display = "none"; // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç”»é¢ã‚’éè¡¨ç¤º
                    waitingScreen.style.display = "flex"; // éƒ¨å±‹IDå…¥åŠ›ç”»é¢ã‚’è¡¨ç¤º
                    waitingMessage.textContent = "éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦å‚åŠ ã—ã¦ãã ã•ã„";
                    roomInputArea.style.display = "flex";
                    stopLoadingAnimation();
                    gameState = "waiting_room";
                    passwordInput.disabled = false; // å…¥åŠ›è¦ç´ ã‚’æœ‰åŠ¹ã«æˆ»ã™
                    submitPasswordButton.disabled = false; // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«æˆ»ã™
                    break;

                case "authentication_failed": // èªè¨¼å¤±æ•—
                    passwordMessage.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚";
                    passwordInput.value = ""; // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                    passwordInput.disabled = false;
                    submitPasswordButton.disabled = false;
                    stopLoadingAnimation();
                    break;

                case "user_assigned": // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¨å“¡ãŒæƒã£ãŸå¾Œã€å‹•ç‰©ãŒå‰²ã‚ŠæŒ¯ã‚‰ã‚ŒãŸé€šçŸ¥
                    userId = data.userId;
                    currentAnimalId = data.animalId;
                    assignedRoomId = data.roomId; // å¿µã®ãŸã‚å†åº¦å–å¾—
                    updateAnimalDisplay(currentAnimalId);
                    showAnimalReveal(); // å‹•ç‰©å…¬é–‹ç”»é¢ã¸é·ç§»
                    break;

                case "players_update":
                    players = data.players;
                    updatePlayersDisplay();
                    break;

                case "game_start_preparation": // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å‹•ç‰©å…¬é–‹å¾Œã®æº–å‚™ã‚’ä¿ƒã™
                    console.log("ã‚²ãƒ¼ãƒ é–‹å§‹æº–å‚™ã‚·ã‚°ãƒŠãƒ«ã‚’å—ä¿¡ã—ã¾ã—ãŸã€‚");
                    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã¯ã™ã§ã«å‹•ç‰©å…¬é–‹ç”»é¢ã«ã„ã‚‹ã¯ãšãªã®ã§ã€ç‰¹ã«ä½•ã‚‚ã—ãªã„
                    // animalReveal.style.display ãŒ "block" ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
                    break;

                case "game_phase":
                    handleGamePhase(data.phase, data.data);
                    break;

                case "countdown":
                    updateCountdownDisplay(data.time);
                    break;

                case "waiting_for_actions":
                    // è‡ªåˆ†ãŒã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ãŸå¾Œã€ã¾ãŸã¯ä»–ã®èª°ã‹ãŒé¸æŠã—ãŸã¨ãã«ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¥ã‚‹
                    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã€Œä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™ã€è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ã‚ã£ã¦ã„ãªã‘ã‚Œã°åˆ‡ã‚Šæ›¿ãˆã‚‹
                    headline.textContent = "ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™...";
                    startLoadingAnimation(statusMessage, "ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™");
                    cardContainer.style.display = "none";
                    statusMessage.style.display = "block";
                    countdownTimer.style.display = "none"; // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
                    break;

                case "error":
                    console.error("ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼:", data.message);
                    alert("ã‚¨ãƒ©ãƒ¼: " + data.message);
                    // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢ã«æˆ»ã‚‹
                    passwordScreen.style.display = "flex";
                    passwordMessage.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                    passwordInput.disabled = false;
                    submitPasswordButton.disabled = false;
                    waitingScreen.style.display = "none";
                    animalReveal.style.display = "none";
                    mainContent.style.display = "none";
                    stopLoadingAnimation();
                    gameState = "password_entry";
                    break;
            }
        }

        // å‹•ç‰©è¡¨ç¤ºæ›´æ–°
        function updateAnimalDisplay(animalId) {
            const animal = animals[animalId];
            if (!animal) return;

            // å‹•ç‰©æ±ºå®šç”»é¢ã®æ›´æ–°
            document.getElementById("animalName").textContent = animal.name;
            document.getElementById("animalDescription").textContent = animal.description;
            document.getElementById("animalImage").src = animal.image;

            // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®æ›´æ–°
            document.getElementById("mainAnimalName").textContent = animal.name;
            document.getElementById("mainAnimalDescription").textContent = animal.description;
            document.getElementById("mainAnimalImage").src = animal.image;

            // ãƒ¡ã‚¤ãƒ³ç”»é¢ã§å‹•ç‰©æƒ…å ±ã‚’è¡¨ç¤ºå¯èƒ½ã«ã™ã‚‹
            animalInfo.classList.add("visible");
        }

        // å‹•ç‰©æ±ºå®šç”»é¢ã‚’è¡¨ç¤ºã—ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
        function showAnimalReveal() {
            gameState = "reveal";
            waitingScreen.style.display = "none"; // å¾…æ©Ÿç”»é¢ã‚’éè¡¨ç¤º
            animalReveal.style.display = "block"; // å‹•ç‰©å…¬é–‹ç”»é¢ã‚’è¡¨ç¤º
            mainContent.style.display = "none"; // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            setTimeout(() => {
                animalReveal.classList.add("show");
            }, 500);
        }

        // ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆ (OKãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸå¾Œ)
        function startMainGame() {
            gameState = "waiting_for_players_ready"; // æ–°ã—ã„çŠ¶æ…‹ã«è¨­å®š
            animalReveal.style.display = "none"; // å‹•ç‰©å…¬é–‹ç”»é¢ã‚’éè¡¨ç¤º
            mainContent.style.display = "block"; // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            countdownTimer.style.display = "none"; // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã¯ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹æ™‚ã«è¡¨ç¤º
            
            // ã‚µãƒ¼ãƒãƒ¼ã«æº–å‚™å®Œäº†ã‚’é€šçŸ¥
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: "ready_for_game", // ã‚µãƒ¼ãƒãƒ¼ã«æº–å‚™å®Œäº†ã‚’ä¼ãˆã‚‹
                    userId: userId,
                    roomId: assignedRoomId
                }));
            }

            // ã€Œä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            statusMessage.style.display = "block";
            startLoadingAnimation(statusMessage, "ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™"); // ã“ã“ã‚’å¤‰æ›´
            headline.style.display = "none"; // ãƒ˜ãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã¯éè¡¨ç¤º
            cardContainer.style.display = "none"; // ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã‚‚éè¡¨ç¤º

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤ºï¼ˆä»»æ„ï¼šã“ã“ã§è¡¨ç¤ºã™ã‚‹ï¼‰
            playersInfo.style.display = "block";
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡¨ç¤ºæ›´æ–°
        function updatePlayersDisplay() {
            const count = Object.keys(players).length;
            playerCount.textContent = count;
            
            playersList.innerHTML = "";
            for (const playerId in players) {
                const player = players[playerId];
                const playerDiv = document.createElement("div");
                playerDiv.className = "player-item";
                
                const statusDiv = document.createElement("div");
                statusDiv.className = `player-status ${player.status}`;
                
                const nameDiv = document.createElement("div");
                const isMe = (player.userId === userId) ? " (ã‚ãªãŸ)" : "";
                nameDiv.textContent = `${animals[player.animalId]?.name || "æœªå®š"} (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player.userId.split('_')[1]})${isMe}`;
                
                playerDiv.appendChild(statusDiv);
                playerDiv.appendChild(nameDiv);
                playersList.appendChild(playerDiv);
            }
        }

        // ã‚²ãƒ¼ãƒ ãƒ•ã‚§ãƒ¼ã‚ºå‡¦ç†
        function handleGamePhase(phase, data) {
            console.log(`ãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´: ${phase}`, data);
            switch (phase) {
                case "discussion":
                    stopLoadingAnimation();
                    headline.textContent = "è­°è«–ä¸­";
                    headline.style.display = "block";
                    cardContainer.style.display = "none";
                    statusMessage.style.display = "none"; // å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
                    countdownTimer.style.display = "none";
                    break;
                    
                case "story_progress": // æ–°ã—ã„ãƒ•ã‚§ãƒ¼ã‚º: ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€²è¡Œä¸­
                    stopLoadingAnimation();
                    headline.textContent = "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€²è¡Œä¸­";
                    headline.style.display = "block";
                    cardContainer.style.display = "none";
                    statusMessage.style.display = "none"; // å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
                    countdownTimer.style.display = "none";
                    break;
                    
                case "action_select":
                    // ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¸æŠUIã‚’è¡¨ç¤º
                    if (gameState === "waiting_for_players_ready" || gameState === "main") { // readinessç¢ºèªå¾Œã‚‚é·ç§»ã§ãã‚‹ã‚ˆã†ã«
                        startGameplay(); // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¸æŠUIã‚’è¡¨ç¤º
                        countdownTimer.style.display = "block"; // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º
                        statusMessage.style.display = "none"; // å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
                    }
                    break;
            }
        }

        // ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤é–‹å§‹ (ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¸æŠãƒ•ã‚§ãƒ¼ã‚º)
        function startGameplay() {
            cardContainer.style.display = "flex";
            statusMessage.style.display = "none";
            stopLoadingAnimation();
            headline.style.display = "block";
            headline.textContent = "è­°è«–ã§ä½•ã‚’ã™ã‚‹ï¼Ÿ";
            
            document.querySelectorAll('.card-button').forEach(btn => {
                btn.classList.remove('disabled'); // å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«æˆ»ã™
            });
        }

        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
        function updateCountdownDisplay(time) {
            countdownTime.textContent = time;
            if (time <= 5 && time > 0) {
                countdownTime.style.color = "red";
            } else {
                countdownTime.style.color = "white";
            }
            if (time <= 0) {
                document.querySelectorAll('.card-button').forEach(btn => {
                    btn.classList.add('disabled');
                });
                headline.textContent = "æ™‚é–“ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¾…ã£ã¦ã„ã¾ã™...";
                startLoadingAnimation(statusMessage, "ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¾…ã£ã¦ã„ã¾ã™");
                cardContainer.style.display = "none";
                statusMessage.style.display = "block";
            }
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡
        function send(actionId) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const message = JSON.stringify({ 
                    type: "action",
                    userId: userId,
                    roomId: assignedRoomId,
                    actionId: actionId,
                    timestamp: Date.now()
                });
                socket.send(message);
                console.log("ğŸ“¤ é€ä¿¡:", message);
            } else {
                console.warn("â›” WebSocketãŒæœªæ¥ç¶šã€‚å†æ¥ç¶šã‚’è©¦ã¿ã¾ã™...");
                connectWebSocket();
            }
        }

        // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showConfirmation(actionId, actionName) {
            selectedActionId = actionId;
            confirmationModal.style.display = "flex";
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¢ºå®š
        function confirmAction() {
            if (selectedActionId !== null) {
                // è‡ªåˆ†ã®é¸æŠè‚¢ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆé¸æŠæ¸ˆã¿ã‚’ç¤ºã™ãŸã‚ï¼‰
                document.querySelectorAll('.card-button').forEach(btn => {
                    // å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹ã«ã™ã‚‹ï¼ˆé¸æŠæ¸ˆã¿ã§ãªã„ã‚‚ã®ã‚‚å«ã‚€ï¼‰
                    btn.classList.add('disabled');
                });

                // ã€Œä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                // ã“ã‚Œã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€ä¿¡ã—ãŸç›´å¾Œã«è¡Œã†è¡¨ç¤º
                headline.textContent = "ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™...";
                startLoadingAnimation(statusMessage, "ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¾…ã£ã¦ã„ã¾ã™");
                cardContainer.style.display = "none"; // é¸æŠè‚¢ã‚’éè¡¨ç¤ºã«
                statusMessage.style.display = "block"; // å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                countdownTimer.style.display = "none"; // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚‚éè¡¨ç¤ºã«ã™ã‚‹

                send(selectedActionId); // ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€ä¿¡
                confirmationModal.style.display = "none";
                selectedActionId = null; // é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            }
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelAction() {
            selectedActionId = null;
            confirmationModal.style.display = "none";
        }

        // åˆæœŸåŒ–
        window.onload = () => {
            // æœ€åˆã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢ã‚’è¡¨ç¤ºã—ã€WebSocketæ¥ç¶šã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼å¾Œã«é–‹å§‹ã™ã‚‹
            // connectWebSocket(); // ã“ã®è¡Œã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã¾ãŸã¯å‰Šé™¤
            passwordScreen.style.display = "flex";
            waitingScreen.style.display = "none"; // éƒ¨å±‹IDå…¥åŠ›ç”»é¢ã¯éè¡¨ç¤º
            animalReveal.style.display = "none";
            mainContent.style.display = "none";
            connectionStatus.style.display = "none"; // åˆæœŸã¯æ¥ç¶šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚‚éè¡¨ç¤º
        };
        
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›å¾Œã€WebSocketæ¥ç¶šã‚’é–‹å§‹ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
        submitPasswordButton.addEventListener('click', () => {
            // ã“ã“ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é€ä¿¡ã™ã‚‹å‰ã«WebSocketæ¥ç¶šã‚’ç¢ºç«‹
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                 connectWebSocket(); // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é€ä¿¡æ™‚ã«WebSocketæ¥ç¶šã‚’é–‹å§‹
            }
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯ã¯ã€connectWebSocket() ãŒæˆåŠŸã—ãŸå¾Œã® socket.onopen å†…ã§
            // 'authenticate' ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹ã‚ˆã†ã«èª¿æ•´ã™ã‚‹ã“ã¨ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™ãŒã€
            // ä»Šå›ã¯ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§æ¥ç¶šã‚’è©¦ã¿ã€ãã®å¾Œã®èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’ç¶šã‘ã¾ã™ã€‚
            // ã‚µãƒ¼ãƒãƒ¼å´ã®`authenticate`ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«ä»»ã›ã¾ã™ã€‚
        });


        // ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹éš›ã®WebSocketåˆ‡æ–­ (å†ãƒ­ãƒ¼ãƒ‰ã‚’é¿ã‘ã‚‹ãŸã‚ onbeforeunload ã‚’å¤‰æ›´)
        window.onbeforeunload = () => {
            if (socket && socket.readyState === WebSocket.OPEN) {
                // æ­£å¸¸çµ‚äº†ã‚³ãƒ¼ãƒ‰1000ã‚’é€ä¿¡ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã«æ„å›³çš„ãªåˆ‡æ–­ã‚’é€šçŸ¥
                socket.close(1000, "User closed the page");
            }
            stopLoadingAnimation();
        };
    </script>
</body>
</html>
